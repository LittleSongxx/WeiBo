# 数据库查看指南

## 系统使用的数据库

### 1. **MongoDB** (端口 27017)
- **用途**：存储分析任务结果、话题数据、用户画像等
- **数据库名**：`test`
- **主要集合(Collection)**：
  - `tag_task` - 话题任务
  - `blog` - 微博内容
  - `tag_word_cloud` - 词云数据
  - `tag_relation_graph` - 关系图数据
  - `tag_user` - 用户标签数据
  - `tag_hot` - 热度数据
  - `comment` - 评论数据
  - `comment_reposts` - 转发数据

### 2. **Redis** (端口 6379)
- **用途**：Celery任务队列的消息代理和结果存储
- **数据库**：
  - DB 0 - Celery Broker (任务队列)
  - DB 1 - Celery Backend (任务结果)

### 3. **Elasticsearch** (端口 9200/9300)
- **用途**：全文搜索引擎（可选功能）
- **索引**：微博内容全文搜索

---

## 查看数据库数据

### MongoDB 查看方法

#### 方法1：使用 MongoDB Shell (推荐)

```bash
# 进入MongoDB容器
docker exec -it topic_analysis_mongodb mongosh

# 或者直接连接（如果本地安装了mongosh）
mongosh mongodb://127.0.0.1:27017/test
```

**常用命令**：
```javascript
// 查看所有数据库
show dbs

// 切换到test数据库
use test

// 查看所有集合
show collections

// 查看话题任务列表
db.tag_task.find().pretty()

// 查看最新10条任务
db.tag_task.find().sort({_id: -1}).limit(10).pretty()

// 统计某个集合的文档数
db.tag_task.countDocuments()

// 查看具体某个任务（替换为实际task_id）
db.tag_task.findOne({task_id: "你的task_id"})

// 查看博文数据
db.blog.find().limit(5).pretty()

// 查看词云数据
db.tag_word_cloud.find().pretty()

// 查看关系图数据
db.tag_relation_graph.find().pretty()

// 查看用户数据
db.tag_user.find().limit(10).pretty()

// 按话题搜索数据
db.blog.find({tag_task_id: "你的task_id"}).limit(10).pretty()

// 删除某个任务的所有数据（谨慎使用）
db.tag_task.deleteOne({task_id: "你的task_id"})
```

#### 方法2：使用 MongoDB Compass (图形界面)

1. 下载安装 [MongoDB Compass](https://www.mongodb.com/products/compass)
2. 连接字符串：`mongodb://127.0.0.1:27017/test`
3. 可视化浏览和查询数据

#### 方法3：使用 Python 脚本查看

```bash
cd ~/code/graduation/Topic_and_user_profile_analysis_system/code/back_end
python3 << 'EOF'
from motor.motor_asyncio import AsyncIOMotorClient
import asyncio

async def view_data():
    client = AsyncIOMotorClient('mongodb://127.0.0.1:27017')
    db = client.test
    
    print("=== 话题任务列表 ===")
    async for doc in db.tag_task.find().limit(5):
        print(f"任务ID: {doc.get('task_id')}")
        print(f"话题: {doc.get('tag_text')}")
        print(f"状态: {doc.get('state')}")
        print(f"创建时间: {doc.get('ctime')}")
        print("-" * 50)
    
    print("\n=== 数据统计 ===")
    for collection in ['tag_task', 'blog', 'tag_word_cloud', 'tag_relation_graph']:
        count = await db[collection].count_documents({})
        print(f"{collection}: {count} 条记录")

asyncio.run(view_data())
EOF
```

---

### Redis 查看方法

```bash
# 方法1：进入Redis容器
docker exec -it topic_analysis_redis redis-cli

# 方法2：直接连接（如果本地安装了redis-cli）
redis-cli -h 127.0.0.1 -p 6379
```

**常用命令**：
```bash
# 切换到DB 0 (Celery Broker)
SELECT 0

# 查看所有键
KEYS *

# 查看Celery任务队列
LLEN celery  # 队列长度
LRANGE celery 0 -1  # 查看所有任务

# 切换到DB 1 (Celery Backend)
SELECT 1

# 查看任务结果
KEYS celery-task-meta-*
GET celery-task-meta-<task_id>

# 查看数据库信息
INFO

# 清空当前数据库（谨慎使用）
FLUSHDB
```

---

### Elasticsearch 查看方法

```bash
# 查看所有索引
curl http://127.0.0.1:9200/_cat/indices?v

# 查看集群健康状态
curl http://127.0.0.1:9200/_cluster/health?pretty

# 搜索数据（示例）
curl -X GET "http://127.0.0.1:9200/weibo_index/_search?pretty" -H 'Content-Type: application/json' -d'
{
  "query": {
    "match_all": {}
  },
  "size": 10
}
'
```

---

## 快速查看脚本

创建一个快速查看脚本：

```bash
# 保存为 view_db.sh
cat > ~/code/graduation/view_db.sh << 'SCRIPT'
#!/bin/bash

echo "=========================================="
echo "  数据库数据快速查看"
echo "=========================================="

echo -e "\n[1] MongoDB 数据统计:"
docker exec -it topic_analysis_mongodb mongosh test --quiet --eval "
  print('话题任务数:', db.tag_task.countDocuments());
  print('博文数:', db.blog.countDocuments());
  print('词云数:', db.tag_word_cloud.countDocuments());
  print('关系图数:', db.tag_relation_graph.countDocuments());
  print('用户数:', db.tag_user.countDocuments());
"

echo -e "\n[2] Redis 数据统计:"
echo "Celery队列任务数:"
docker exec -it topic_analysis_redis redis-cli -n 0 LLEN celery

echo -e "\n[3] 最新的5个话题任务:"
docker exec -it topic_analysis_mongodb mongosh test --quiet --eval "
  db.tag_task.find({}, {tag_text:1, state:1, ctime:1}).sort({_id:-1}).limit(5).forEach(printjson)
"

echo -e "\n=========================================="
SCRIPT

chmod +x ~/code/graduation/view_db.sh
echo "✓ 脚本已创建: ~/code/graduation/view_db.sh"
```

使用：`bash ~/code/graduation/view_db.sh`

---

## 数据清理命令

```bash
# 清空MongoDB所有数据（谨慎使用！）
docker exec -it topic_analysis_mongodb mongosh test --eval "db.dropDatabase()"

# 清空Redis所有数据（谨慎使用！）
docker exec -it topic_analysis_redis redis-cli FLUSHALL

# 只清空某个集合
docker exec -it topic_analysis_mongodb mongosh test --eval "db.tag_task.deleteMany({})"
```
